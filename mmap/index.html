<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Marauder's Map</title>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&amp;libraries=places"></script>
	</script>
	<link rel="stylesheet" href="style.css">
	<script>
		var characters = [ ];
		var students = [ ];

		function initializeMap() {
			var init_lat = 42.4060269;
    		var init_lng = -71.118939;

	    	// set the map options (zoom and location)
			mapOptions = {
				center: {lat: init_lat, lng: init_lng},
				zoom: 12
			};

			// create the map
			map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		}

	    function addCharacterMarker(cha_name,cha_lat,cha_lng,cha_note) {
	    	var name;
	    	var image;

	    	if (cha_name == 'carmen'){
	    		name = 'Carmen Sandiego';
	    		image = 'images/carmen.png';
	    	} else if (cha_name == 'waldo') {
	    		name = 'Waldo';
	    		image = 'images/waldo.png';
	    	} else if (cha_name == 'batman') {
	    		name = 'Batman';
	    		image = 'images/batman.png';
	    	} else if (cha_name == 'nr') {
	    		name = 'Professor Norman Ramsey';
	    		image = 'images/nr.png';
	    	} else if (cha_name == 'snape') {
	    		name = 'Professor Severus Snape';
	    		image = 'images/snape.png';
	    	} else if (cha_name == 'hescott') {
	    		name = 'Professor Ben Hescott';
	    		image = 'images/hescott.png';
	    	}

	        marker = new google.maps.Marker({
			    position: {lat: cha_lat, lng: cha_lng},
			    map: map,
			    icon: image
			});
			return marker;
	    }

	    function addStudentMarker(in_lat,in_lng) {
	        marker = new google.maps.Marker({
			    position: {lat: in_lat, lng: in_lng},
			    map: map
			});
			return marker;
	    }

		function getData() {
			if (xhr.readyState == 4 && xhr.status == 200) {
	    		var data = JSON.parse(xhr.responseText);

	    		characters = data["characters"];
	    		students = data["students"];
	    		
	    		for (i=0;i<characters.length;i++){
	    			cha_name = characters[i]['name'];
	    			cha_lat = characters[i]['loc']['latitude'];
	    			cha_lng = characters[i]['loc']['longitude'];
	    			cha_note = characters[i]['loc']['note'];

	    			addCharacterMarker(cha_name,cha_lat,cha_lng,cha_note);
	    		}

	    		for (i=0;i<students.length;i++){
	    			stu_login = students[i]['login'];
	    			stu_lat = students[i]['lat'];
	    			stu_lng = students[i]['lng'];
	    			stu_time = students[i]['created_at'];
	    			
	    			addStudentMarker(stu_lat,stu_lng);
	    		}

	    	} else if (xhr.readyState == 4) {
	    		// error message
	    	}
		}
		
		xhr = new XMLHttpRequest();
		xhr.open('post', 'http://chickenofthesea.herokuapp.com/sendLocation', true);
		xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		xhr.onreadystatechange = getData;

		if (navigator.geolocation) {
	   		navigator.geolocation.getCurrentPosition(function(position) {
				var curr_lat = position.coords.latitude;
				var curr_lng = position.coords.longitude;

				xhr.send("login=TimmyBurch&lat=" + curr_lat + "&lng=" + curr_lng);

				map.setCenter({lat: curr_lat, lng: curr_lng});
				marker = new google.maps.Marker({
					position: {lat: curr_lat, lng: curr_lng},
					map: map,
					icon: 'images/timmy.png',
					zIndex: 100
				});
			});
	   	} else {
	   		// no geolocation
	   	}
		 
		google.maps.event.addDomListener(window, 'load', initializeMap);
	</script>
</head>
<body>
	<div id="map-canvas"></div>
</body>
</html>